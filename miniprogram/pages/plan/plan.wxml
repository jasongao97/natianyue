<!--pages/plan/plan.wxml-->
<wxs module="tools" src="../../util/tools.wxs"></wxs>

<!-- å¯¼èˆªæ  -->
<navigation-bar title="{{notFound ? 'ç¾¤çº¦ä¸å­˜åœ¨' : 'ç¾¤çº¦è¯¦æƒ…'}}" action="back" loading="{{!loaded || reopening}}" />

<!-- ç»“æœæ—¶é—´é€‰æ‹© -->
<half-modal show="{{showResultPicker}}" bind:modalClose="handleResultPickerClose" title="è¯·é€‰æ‹©ç¡®å®šçš„æ—¶é—´" description="å°†æ¨é€ç»™è®¢é˜…ç”¨æˆ·å¹¶æš‚åœæŠ¥å" rightButtonName="å‘é€" rightButtonColor="{{resultActiveIndex === -1 ? '#b2b2b2' : '#3ABB6A'}}" bind:rightButtonTap="handleClosePlan" loading="{{submittingResult}}">
	<scroll-view class="editor-scroll" scroll-y="true">
		<section margin="{{false}}">
			<view class="result-option-block" wx:for="{{resultList}}" wx:key="index" id="{{index}}" bind:tap="handleResultPickerSwitch">
				<view class="radio">
					<view class="radio-center {{index === resultActiveIndex ? 'active' : ''}}"></view>
				</view>
				<view class="description">
					<text>{{item.name}}</text>
					<text>{{item.supporters.length}}/{{participations.length}}äººé€‰æ‹©</text>
				</view>
			</view>
		</section>
	</scroll-view>
</half-modal>

<!-- é”å®šé€‰é¡¹ -->
<half-modal show="{{showLockEditor}}" bind:modalClose="handleLockEditorClose" title="é”å®šé€‰é¡¹ç¼–è¾‘" description="è¯·ç‚¹å‡»é€‰æ‹©éœ€è¦é”å®šçš„æ—¶é—´æ®µ" rightButtonName="ç¡®å®š" rightButtonColor="{{lockSettingHasChanged ? '#3ABB6A' : '#b2b2b2'}}" bind:rightButtonTap="handleUpdateLock" loading="{{submittingLock}}">
	<scroll-view class="editor-scroll" scroll-y="true">
		<view class="option-block segment" wx:if="{{option.mode === 'segment'}}">
			<view class="side-column">
				<text class="row-title" wx:for="{{option.segments}}" wx:key="index">{{item}}</text>
			</view>
			<view class="main" style="grid-template-columns: repeat({{option.range}}, minmax(0, 1fr));">
				<view class="column-title"
					wx:for="{{tools.datesBetween(option.startDate, tools.dateAdd(option.startDate, option.range - 1))}}"
					wx:key="index">
					<text class="title">{{tools.displayDate(item, 'ddæ—¥')}}</text>
					<text class="subtitle">{{tools.displayDate(item, 'å‘¨D')}}</text>
				</view>
				<view
					class="cell {{index < option.range ? 'top' : ''}} {{index >= (option.segments.length - 1) * option.range ? 'bottom' : ''}} {{item.selectedLock ? 'selected-lock' : ''}}"
					wx:for="{{resultGraph}}" wx:key="index" data-index="{{index}}" bind:tap="toggleLocked">
					<image wx:if="{{item.selectedLock}}" src="/icons/lock-light.png"></image>
				</view>
			</view>
		</view>

		<view class="option-block day" wx:if="{{option.mode === 'day'}}">
			<view class="title" wx:for="{{tools.dayNames()}}" wx:key="index">å‘¨{{item}}</view>
			<view class="cell {{item.disable ? 'disable' : item.selectedLock ? 'selected-lock' : ''}}" wx:for="{{resultGraph}}" wx:key="index" data-index="{{index}}" bind:tap="toggleLocked">
				<image wx:if="{{item.selectedLock}}" src="/icons/lock-light.png"></image>
				<text class="title">{{item.name}}</text>
			</view>
		</view>

		<view class="option-block list" wx:if="{{option.mode === 'list'}}">
			<view class="cell {{item.selectedLock ? 'selected-lock' : ''}}" wx:for="{{resultGraph}}" wx:key="index" data-index="{{index}}" bind:tap="toggleLocked">
				<image wx:if="{{item.selectedLock}}" src="/icons/lock-light.png"></image>
				<text wx:else>{{item.name}}<text style="opacity: 0.7;"> ï¼ˆ{{item.votes ? item.votes + ' ' : 'æ— '}}äººé€‰æ‹©ï¼‰</text></text>
			</view>
		</view>
	</scroll-view>
</half-modal>

<!-- å¤´åƒåŠæ˜µç§°è¯¦æƒ…Toast -->
<view wx:if="{{hoverUser.show}}" class="voter-hover" style="{{hoverUser.position}}">
  <view class="voter-hover-toast">
    <avatar src="{{hoverUser.avatar}}" animation="{{false}}" avatar-style="height: 140rpx; width: 140rpx; border-radius: 8rpx;"></avatar>
    <text>{{hoverUser.nickName}}</text>
  </view>
  <view class="voter-hover-toast-triangle"></view>
</view>

<!-- åŠ è½½å ä½ -->
<container wx:if="{{!loaded}}">
	<section margin="{{false}}">
		<view class="info-block">
			<view class="title-holder"></view>
			<view class="info-holder animation-{{tools.randomAni(0)}}"></view>
			<view class="info-holder animation-{{tools.randomAni(1)}}"></view>
		</view>
	</section>

	<image class="plan-holder breathing" src="../../images/planholder.png"></image>
</container>

<!-- ä¸å­˜åœ¨å ä½ -->
<container class="fadein" wx:if="{{loaded && notFound}}">
	<view class="notfound-modal">
		<text>è¯¥ç¾¤çº¦ä¸å­˜åœ¨æˆ–å·²åˆ é™¤</text>
		<btn size="medium" bind:tap="handleBackHome">å›åˆ°é¦–é¡µ</btn>
	</view>
	<view style="opacity: 0.3;">
		<section margin="{{false}}">
			<view class="info-block">
				<view class="title-holder" style="transform: rotate(1deg);"></view>
				<view class="info-holder" style="transform: rotate(-1deg);"></view>
				<view class="info-holder"></view>
			</view>
		</section>

		<image class="plan-holder" src="../../images/planholder.png"></image>
	</view>
</container>

<!-- æ­£å¸¸æ˜¾ç¤º -->
<container class="fadein" wx:if="{{loaded && !notFound}}">
	<section margin="{{false}}">
		<view class="top-block">
			<view class="info-block {{!result ? 'hide-right-padding' : ''}}">
				<view class="title-block">
					<text class="title">{{title}}</text>
					<view class="status {{result ? 'close' : 'open'}}">{{result ? 'å·²ç¡®å®š' : 'æŠ¥åä¸­'}}</view>
				</view>
				<text wx:if="{{!result}}">
					<block wx:if="{{option.mode === 'segment' || option.mode === 'day'}}">{{tools.displayDate(option.startDate, 'yyyyå¹´MMæœˆddæ—¥')}} ~ {{tools.displayDate(tools.dateAdd(option.startDate, option.range - 1), 'MMæœˆddæ—¥')}}</block>
					<block wx:if="{{option.mode === 'segment' && option.segments.length < 3}}"> çš„ {{tools.joinArray(option.segments, 'ã€')}}</block>
					<block wx:if="{{option.mode === 'segment' && option.segments.length >= 3}}"> çš„ {{option.segments[0]}} ç­‰{{option.segments.length}}ä¸ªæ—¶æ®µ</block>
					<block wx:if="{{option.mode === 'list'}}">{{option.list.length}}ä¸ªé€‰é¡¹</block>
				</text>
				<text wx:if="{{result}}">{{result.name}}</text>
				<text>
					<block>ç”±{{creator}}å‘èµ·</block>
					<block wx:if="{{participations.length}}"> | å·²æœ‰{{participations.length}}äººæŠ¥å</block>
					<block wx:else> | æš‚æ— äººæŠ¥å</block>
				</text>
			</view>
			<view class="subscribe-button" bind:tap="handleSubscribeMessage" wx:if="{{!result}}">
				<view class="lds-dual-ring" wx:if="{{subscribing}}"></view>
				<block wx:else>
					<image src="../../icons/subscribe-{{subscribed ? 'on' : 'off'}}.png"></image>
					<text class="{{subscribed ? 'on' : ''}}">ç»“æœé€šçŸ¥</text>
				</block>
			</view>
		</view>
		<view class="remark-block" wx:if="{{remark}}">{{remark}}</view>
	</section>

	<view class="option-block segment" wx:if="{{option.mode === 'segment'}}">
		<view class="side-column">
			<text class="row-title" wx:for="{{option.segments}}" wx:key="index">{{item}}</text>
		</view>
		<view class="main" style="grid-template-columns: repeat({{option.range}}, minmax(0, 1fr));">
			<view class="column-title" wx:for="{{tools.datesBetween(option.startDate, tools.dateAdd(option.startDate, option.range - 1))}}" wx:key="index">
				<text class="title">{{tools.displayDate(item, 'ddæ—¥')}}</text>
				<text class="subtitle">{{tools.displayDate(item, 'å‘¨D')}}</text>
			</view>
			<view class="cell {{index < option.range ? 'top' : ''}} {{index >= (option.segments.length - 1) * option.range ? 'bottom' : ''}} {{item.locked ? 'locked' : item.votes ? 'active' : ''}} {{result.index === item.originalIndex ? 'result' : ''}}" wx:for="{{resultGraph}}" wx:key="index">
				<view class="cell-bg" wx:if="{{!item.disable && !item.locked && !result}}" style="transform: translateY({{100 - item.votes / participations.length * 100}}%); background-color: hsl(143,{{43 + item.votes / participations.length * 10}}%,{{78 - item.votes / participations.length * 30}}%);"></view>
				<image wx:if="{{item.locked}}" src="/icons/lock.png"></image>
				<text wx:else>{{item.votes}}</text>
			</view>
		</view>
	</view>

	<view class="option-block day" wx:if="{{option.mode === 'day'}}">
		<view class="title" wx:for="{{tools.dayNames()}}" wx:key="index">å‘¨{{item}}</view>
		<view class="cell {{item.locked ? 'locked' : item.votes ? 'active' : ''}} {{item.disable ? 'disable' : result.index === item.originalIndex ? 'result' : ''}}" wx:for="{{resultGraph}}" wx:key="index">
			<view class="cell-bg" wx:if="{{!item.disable && !item.locked && !result}}" style="transform: translateY({{100 - item.votes / participations.length * 100}}%); background-color: hsl(143,{{43 + item.votes / participations.length * 10}}%,{{78 - item.votes / participations.length * 30}}%);"></view>
			<image wx:if="{{item.locked}}" src="/icons/lock.png"></image>
			<block wx:else>
				<text class="title">{{item.name}}</text>
				<text>{{item.votes}}</text>
			</block>
		</view>
	</view>

	<view class="option-block list" wx:if="{{option.mode === 'list'}}">
		<view class="cell {{item.locked ? 'locked' : item.votes ? 'active' : ''}} {{result.index === item.originalIndex ? 'result' : ''}}" wx:for="{{resultGraph}}" wx:key="index">
			<view class="cell-bg" wx:if="{{!item.disable && !item.locked && !result}}" style="transform: translateX({{(item.votes / participations.length - 1) * 100}}%); background-color: hsl(143,{{43 + item.votes / participations.length * 10}}%,{{78 - item.votes / participations.length * 30}}%);"></view>
			<image wx:if="{{item.locked}}" src="/icons/lock.png"></image>
			<text wx:else>{{item.name}}<text style="opacity: 0.7;"> ï¼ˆ{{item.votes ? item.votes + ' ' : 'æ— '}}äººé€‰æ‹©ï¼‰</text></text>
		</view>
	</view>

	<block wx:if="{{!result}}">
		<block wx:if="{{registered}}">
			<block wx:if="{{mySelection}}">
				<btn openType="share" class="btn-margin">é‚€è¯·å¥½å‹</btn>
				<btn type="secondary" bind:tap="handleEditParticipation">ä¿®æ”¹æŠ¥å</btn>
			</block>
			<block wx:else>
				<btn bind:tap="handleEditParticipation">æˆ‘è¦æŠ¥å</btn>
			</block>
		</block>
		<block wx:else>
			<btn open-type="getUserInfo" bind:getUserInfo="handleUserInfo">{{registering ? 'æ³¨å†Œä¸­...': 'æˆæƒä¿¡æ¯å¹¶æŠ¥å'}}</btn>
		</block>
	</block>

	<section title="æ¨èæ—¶é—´" wx:if="{{resultList.length}}">
		<view class="recommendation-setting-block">
			<view class="setting {{recommendationSettings.displaySupporters ? 'active' : ''}}" bind:tap="handleRecommendationSettingSwitch" data-type="can">
				<view class="radio">
					<view class="center"></view>
				</view>
				<text>æ˜¾ç¤ºæœ‰ç©ºçš„</text>
			</view>
			<view class="setting {{recommendationSettings.displaySupporters ? '' : 'active'}}" bind:tap="handleRecommendationSettingSwitch" data-type="cant">
				<view class="radio">
					<view class="center"></view>
				</view>
				<text>æ˜¾ç¤ºæ²¡ç©ºçš„</text>
			</view>
		</view>
		<view class="recommendation-block" wx:for="{{resultList}}" wx:if="{{showFullRecommendation || index < 3}}" wx:key="index">
			<view class="description">
				<text class="name">{{item.name}}</text>
				<text class="subname" wx:if="{{recommendationSettings.displaySupporters}}">{{item.supporters.length === participations.length ? 'å…¨å‘˜æœ‰ç©º' : item.supporters.length + 'äººæœ‰ç©º'}}</text>
				<text class="subname" wx:else>{{item.supporters.length === participations.length ? 'å…¨å‘˜æœ‰ç©º' : (participations.length - item.supporters.length) + 'äººæ²¡ç©º'}}</text>
			</view>
			<view class="voters" wx:if="{{recommendationSettings.displaySupporters}}">
				<view class="voter" wx:for="{{item.supporters}}" wx:for-item="voter" wx:key="index"
					data-avatar="{{voter.avatar}}" data-nick-name="{{voter.nickName}}" bind:touchstart="handleUserHoverStart" bind:touchend="handleUserHoverEnd">
					<avatar src="{{voter.avatar}}" avatar-style="height: 80rpx; width: 80rpx; border-radius: 6rpx;"></avatar>
				</view>
			</view>
			<view class="voters" wx:else>
				<view class="no-voter-text" wx:if="{{!item.antis.length}}">ğŸˆšï¸</view>
				<view class="voter" wx:for="{{item.antis}}" wx:for-item="voter" wx:key="index"
					data-avatar="{{voter.avatar}}" data-nick-name="{{voter.nickName}}" bind:touchstart="handleUserHoverStart" bind:touchend="handleUserHoverEnd">
					<avatar disable src="{{voter.avatar}}" avatar-style="height: 80rpx; width: 80rpx; border-radius: 6rpx;"></avatar>
				</view>
			</view>
		</view>
		<view class="show-full-recommendation-button" wx:if="{{!showFullRecommendation && resultList.length > 3}}" bind:tap="handleShowFullRecommendation">
			<text>å±•å¼€å…¨éƒ¨æ—¶é—´æ®µæŠ¥åæƒ…å†µ (å…±{{resultList.length}}æ¡)</text>
			<image src="../../icons/down.png"></image>
		</view>
	</section>

	<section title="ç®¡ç†åŠŸèƒ½" wx:if="{{isCreator}}">
		<block wx:if="{{!result}}">
			<view class="manage-block" hover-class="manage-block-hover" wx:if="{{resultList.length}}" bind:tap="handleOpenResultPicker">
				<text>å‘é€ç¡®å®šæ—¥æœŸé€šçŸ¥</text>
				<image src="../../icons/enter.png"></image>
			</view>
			<view class="manage-block" hover-class="manage-block-hover" bind:tap="handleEditLock">
				<text>é”å®šé€‰é¡¹</text>
				<image src="../../icons/enter.png"></image>
			</view>
			<view class="manage-block" hover-class="manage-block-hover" bind:tap="handleEditPlan">
				<text>ä¿®æ”¹ç¾¤çº¦æ ‡é¢˜</text>
				<image src="../../icons/enter.png"></image>
			</view>
		</block>
		<view wx:if="{{result}}" class="manage-block" hover-class="manage-block-hover" bind:tap="handleReopenPlan">
			<text>å¼€å¯æŠ¥å</text>
			<image src="../../icons/enter.png"></image>
		</view>
	</section>

	<section title="æ›´å¤šåŠŸèƒ½">
		<view class="manage-block" hover-class="manage-block-hover" bind:tap="handleGetQR">
			<text>ç”Ÿæˆç¾¤çº¦åˆ†äº«ç </text>
			<image src="../../icons/enter.png"></image>
		</view>
		<view class="manage-block" hover-class="manage-block-hover" bind:tap="handleGetXLSX">
			<text>å¯¼å‡ºæŠ¥åæ•°æ®è¡¨æ ¼</text>
			<image src="../../icons/enter.png"></image>
		</view>
	</section>
</container>